name: 从 Gitee 镜像编辑器和文档的主分支

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  mirror:
    runs-on: ubuntu-latest
    outputs:
      has_changes: ${{ steps.check_changes.outputs.has_changes }}

    steps:
    - name: 检出 GitHub 仓库
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.PAT }}

    - name: 设置 Git
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"

    - name: 添加 Gitee 远程仓库
      run: |
        git remote add gitee https://gitee.com/oldsquaw-coco-next/CoCo-Next.git
        git remote add docs-gitee https://gitee.com/oldsquaw-coco-next/CoCo-Next-Docs.git

    - name: 从 Gitee 获取更新
      run: |
        git fetch gitee
        git fetch docs-gitee

    - name: 检查编辑器分支变化
      id: check_editor
      run: |
        git checkout editor
        OLD_HEAD=$(git rev-parse HEAD)
        git reset --hard gitee/main
        NEW_HEAD=$(git rev-parse HEAD)
        if [ "$OLD_HEAD" != "$NEW_HEAD" ]; then
          echo "editor_changed=true" >> $GITHUB_OUTPUT
        else
          echo "editor_changed=false" >> $GITHUB_OUTPUT
        fi

    - name: 检查文档分支变化
      id: check_docs
      run: |
        git checkout docs
        OLD_HEAD=$(git rev-parse HEAD)
        git reset --hard docs-gitee/main
        NEW_HEAD=$(git rev-parse HEAD)
        if [ "$OLD_HEAD" != "$NEW_HEAD" ]; then
          echo "docs_changed=true" >> $GITHUB_OUTPUT
        else
          echo "docs_changed=false" >> $GITHUB_OUTPUT
        fi

    - name: 设置整体变化标志
      id: check_changes
      run: |
        if [ "${{ steps.check_editor.outputs.editor_changed }}" == "true" ] || [ "${{ steps.check_docs.outputs.docs_changed }}" == "true" ]; then
          echo "has_changes=true" >> $GITHUB_OUTPUT
        else
          echo "has_changes=false" >> $GITHUB_OUTPUT
        fi

    - name: 强制推送到 GitHub
      run: |
        git push https://${{ secrets.PAT }}@github.com/${{ github.repository }}.git --all --force
        git push https://${{ secrets.PAT }}@github.com/${{ github.repository }}.git --tags --force

    - name: 清理
      run: |
        git remote remove gitee
        git remote remove docs-gitee

  build:
    needs: mirror
    if: ${{ needs.mirror.outputs.has_changes == 'true' }}
    uses: ./.github/workflows/build.yml
    permissions:
      contents: write
    secrets: inherit
