{"version":3,"file":"static/scripts/proxy.b7ed91e26ceaefd8.js","sources":["webpack://coco-next/./helper/proxy.ts"],"sourcesContent":["interface Window {\n    SLIGHTNING_CODEMAO_ENVIRONMENT_XML_HTTP_REQUEST?: boolean\n    SLIGHTNING_CODEMAO_ENVIRONMENT_FETCH?: boolean\n    SLIGHTNING_CODEMAO_ENVIRONMENT_WEB_SOCKET?: boolean\n    COCO_SOURCE_CODE_PLAN_PROXY_OPEN?: boolean\n    COCO_SOURCE_CODE_PLAN_PROXY_IFRAME?: boolean\n}\n\nfunction proxyAll() {\n    proxyXMLHttpRequest()\n    proxyFetch()\n    proxyWebSocket()\n    proxyOpen()\n    proxyIFrame()\n}\n\nfunction proxyXMLHttpRequest() {\n    if (flag(\"SLIGHTNING_CODEMAO_ENVIRONMENT_XML_HTTP_REQUEST\")) {\n        return\n    }\n    let originalOpen: typeof XMLHttpRequest.prototype.open = XMLHttpRequest.prototype.open\n    XMLHttpRequest.prototype.open = function open(\n        method: string,\n        url: string | URL,\n        async?: boolean,\n        username?: string | null,\n        password?: string | null\n    ): void {\n        if (!(url instanceof window.URL)) {\n            url = new URL(url, location.href)\n        }\n        if (needsProxy(url)) {\n            originalOpen.call(this, method, rewriteURL(url), async ?? true, username, password)\n        } else {\n            originalOpen.call(this, method, url, async ?? true, username, password)\n        }\n    }\n    XMLHttpRequest.prototype.open.toString = originalOpen.toString.bind(originalOpen)\n}\n\nfunction proxyFetch() {\n    if (flag(\"SLIGHTNING_CODEMAO_ENVIRONMENT_FETCH\")) {\n        return\n    }\n    let originalFetch: typeof fetch = fetch\n    window.fetch = function fetch(\n        input: RequestInfo | URL,\n        init: RequestInit | undefined\n    ): Promise<Response> {\n        if (input instanceof Request) {\n            input = input.url\n        }\n        if (typeof input == \"string\") {\n            input = new URL(input, location.href)\n        }\n        if (needsProxy(input)) {\n            input = rewriteURL(input)\n        }\n        return originalFetch.call(this, input, init)\n    }\n    fetch.toString = originalFetch.toString.bind(originalFetch)\n}\n\nfunction proxyWebSocket() {\n    if (flag(\"SLIGHTNING_CODEMAO_ENVIRONMENT_WEB_SOCKET\")) {\n        return\n    }\n    window.WebSocket = class WebSocket extends window.WebSocket {\n        public constructor(url: string | URL, protocols?: string | string[]) {\n            if (typeof url == \"string\") {\n                url = new URL(url, location.href)\n            }\n            if (needsProxy(url)) {\n                url = rewriteURL(url)\n            }\n            super(url, protocols)\n        }\n    }\n}\n\nfunction needsProxy(url: URL): boolean {\n    if (\n        !url.hostname.endsWith(\".codemao.cn\") ||\n        url.hostname == \"static.codemao.cn\" ||\n        url.hostname == \"creation.codemao.cn\" ||\n        url.hostname == \"cdn-community.codemao.cn\" ||\n        url.hostname.endsWith(\"bcmcdn.com\") ||\n        (location.hostname != \"coco-next.localhost\" && url.hostname.startsWith(\"socket\"))\n    ) {\n        return false\n    }\n    return true\n}\n\nfunction rewriteURL(url: URL): URL {\n    if (location.hostname.endsWith(\".ccwidget.top\")) {\n        const newURL = new URL(url.protocol + \"//next.ccwidget.top/proxy/\")\n        newURL.searchParams.set(\"__proxy_url__\", url.href)\n        return newURL\n    }\n    url.pathname = \"/proxy/\" + url.origin\n        .replace(/(?<=^https?:\\/\\/)dev-/, \"\")\n        .replace(/(?<=^https?:\\/\\/)backend-dev/, \"api\")\n        + url.pathname\n    if (location.protocol == \"http:\") {\n        if (url.protocol == \"https:\") {\n            url.protocol = \"http:\"\n        }\n        if (url.protocol == \"wss:\") {\n            url.protocol = \"ws:\"\n        }\n    }\n    url.host = location.host\n    return url\n}\n\nfunction proxyOpen() {\n    if (flag(\"COCO_SOURCE_CODE_PLAN_PROXY_OPEN\")) {\n        return\n    }\n    const originalOpen: typeof open = open\n    window.open = function open(\n        url?: string | URL,\n        target?: string,\n        features?: string\n    ): WindowProxy | null {\n        if (typeof url == \"string\") {\n            url = new URL(url, location.href)\n        }\n        if (\n            url?.host == \"www.codemao.cn\" &&\n            (url.pathname == \"/get-qq-code.html\" || url.pathname == \"/get-weixin-code.html\")\n        ) {\n            if (location.protocol == \"http:\" && url.protocol == \"https:\") {\n                url.protocol = \"http:\"\n            }\n            url.host = location.host\n        } else if (\n            url?.hostname.endsWith(\"coco.codemao.cn\") ||\n            url?.hostname == location.hostname\n        ) {\n            url.protocol = location.protocol\n            url.host = location.host\n        }\n        return originalOpen.call(this, url, target, features)\n    }\n    open.toString = originalOpen.toString.bind(originalOpen)\n}\n\nfunction proxyIFrame() {\n    if (flag(\"COCO_SOURCE_CODE_PLAN_PROXY_IFRAME\")) {\n        return\n    }\n    const observer = new MutationObserver((mutationList) => {\n        for (const mutation of mutationList) {\n            for (const node of Array.from(mutation.addedNodes)) {\n                if (node instanceof HTMLIFrameElement) {\n                    changeIFrameSrc(node)\n                } if (node instanceof HTMLElement) {\n                    for (const child of Array.from(node.querySelectorAll(\"*\"))) {\n                        if (child instanceof HTMLIFrameElement) {\n                            changeIFrameSrc(child)\n                        }\n                    }\n                }\n            }\n        }\n    })\n    observer.observe(document.documentElement, {\n        subtree: true,\n        childList: true\n    })\n}\n\nfunction changeIFrameSrc(iFrame: HTMLIFrameElement) {\n    const src = new URL(iFrame.src, location.href)\n    if (src.host == \"shequ.codemao.cn\" && src.pathname.startsWith(\"/codemao_login\")) {\n        if (location.protocol == \"http:\" && src.protocol == \"https:\") {\n            src.protocol = \"http:\"\n        }\n        src.host = location.hostname.endsWith(\".ccwidget.top\") ? \"next.ccwidget.top\" : location.host\n        iFrame.src = src.href\n    }\n}\n\nfunction flag(key: keyof Window): boolean {\n    if (window[key]) {\n        return true\n    }\n    Object.defineProperty(window, key, {\n        value: true,\n        enumerable: false,\n        writable: true,\n        configurable: true\n    })\n    return false\n}\n\nif (!location.hostname.endsWith(\".codemao.cn\")) {\n    proxyAll()\n}\n"],"names":["needsProxy","url","location","rewriteURL","newURL","URL","changeIFrameSrc","iFrame","src","flag","key","window","Object","proxyXMLHttpRequest","originalOpen","XMLHttpRequest","method","async","username","password","proxyFetch","originalFetch","fetch","input","init","Request","protocols","proxyOpen","open","target","features","observer","MutationObserver","mutationList","mutation","node","Array","HTMLIFrameElement","HTMLElement","child","document"],"mappings":"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"}